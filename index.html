<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emerging Life Simulation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html { 
            margin: 0; 
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000; 
            overflow: hidden; 
            font-family: 'Courier New', Courier, monospace; 
            color: #0f0; 
        }
        canvas { 
            display: block; 
            width: 100%;
            height: 100%;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 30, 0, 0.85);
            border: 1px solid #00ffcc;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.2);
            padding: 20px;
            border-radius: 12px;
            width: 280px;
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        h3 { margin: 0 0 15px 0; color: #00ffcc; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        hr { border: 0; border-top: 1px solid #004433; margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #aaa; }
        input[type=range] { 
            width: 100%; 
            margin-bottom: 15px; 
            cursor: pointer;
            accent-color: #00ffcc;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h3>ðŸ§¬ Evolution Control</h3>
        
        <div class="stat-row">
            <span>Avg Energy:</span>
            <span id="val-energy" style="color: #fff; font-weight: bold;">100</span>
        </div>
        <div class="stat-row">
            <span>Population:</span>
            <span id="val-pop">800</span>
        </div>
        
        <hr>
        
        <label>Simulation Speed (Multiplier)</label>
        <input type="range" id="speed" min="1" max="20" value="1">
        
        <label>Mutation Rate: <span id="val-mut" style="color:#fff">0.1</span></label>
        <input type="range" id="mutation" min="0.01" max="1.0" step="0.01" value="0.1">
    </div>

    <canvas id="canvas"></canvas>

    <script type="module">
        import init, { Simulation } from './pkg/life_simulation.js';

        async function run() {
            await init();

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            function resize() {
                const dpr = window.devicePixelRatio || 1;
                const physicalWidth = window.innerWidth * dpr;
                const physicalHeight = window.innerHeight * dpr;

                canvas.width = physicalWidth;
                canvas.height = physicalHeight;

                canvas.style.width = window.innerWidth + "px";
                canvas.style.height = window.innerHeight + "px";

                if (window.sim) {
                    window.sim.resize(physicalWidth, physicalHeight);
                }
                
                return { w: physicalWidth, h: physicalHeight };
            }

            const size = resize();
            window.addEventListener('resize', resize);

            const sim = Simulation.new(size.w, size.h);
            window.sim = sim; 

            const elEnergy = document.getElementById('val-energy');
            const elMut = document.getElementById('val-mut');
            const sliderSpeed = document.getElementById('speed');
            const sliderMut = document.getElementById('mutation');

            sliderMut.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                elMut.innerText = val.toFixed(2);
                sim.set_mutation_rate(val); 
            });

            function loop() {
                const steps = parseInt(sliderSpeed.value);
                for(let i=0; i<steps; i++) {
                    sim.step();
                }

                sim.draw(ctx);
                elEnergy.innerText = sim.get_avg_energy().toFixed(1);

                requestAnimationFrame(loop);
            }
            loop();
        }
        run();
    </script>
</body>
</html>