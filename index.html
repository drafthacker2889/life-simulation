<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emerging Life Simulation</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; color: #0f0; }
        canvas { display: block; }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #0f0;
            padding: 15px;
            border-radius: 8px;
            width: 250px;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        input[type=range] { width: 100%; accent-color: #0f0; }
    </style>
</head>
<body>
    <div id="ui">
        <h3 style="margin-top:0">Evolution Control</h3>
        
        <div class="stat-row">
            <span>Avg Energy:</span>
            <span id="val-energy">100</span>
        </div>
        
        <hr style="border-color: #040;">
        
        <label>Simulation Speed</label>
        <input type="range" id="speed" min="1" max="10" value="1">
        
        <label>Mutation Rate: <span id="val-mut">0.1</span></label>
        <input type="range" id="mutation" min="0.01" max="1.0" step="0.01" value="0.1">
    </div>

    <canvas id="canvas"></canvas>

    <script type="module">
        import init, { Simulation } from './pkg/life_simulation.js';

        async function run() {
            await init();

            const canvas = document.getElementById('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');

            // 1. Create Simulation Instance
            const sim = Simulation.new(canvas.width, canvas.height);

            // 2. UI References
            const elEnergy = document.getElementById('val-energy');
            const elMut = document.getElementById('val-mut');
            const sliderSpeed = document.getElementById('speed');
            const sliderMut = document.getElementById('mutation');

            // 3. UI Listeners
            sliderMut.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                elMut.innerText = val;
                sim.set_mutation_rate(val); // Call Rust!
            });

            // 4. The Loop
            function loop() {
                // Run physics multiple times per frame for speed
                const steps = parseInt(sliderSpeed.value);
                for(let i=0; i<steps; i++) {
                    sim.step();
                }

                // Render once
                sim.draw(ctx);

                // Update Stats
                elEnergy.innerText = sim.get_avg_energy().toFixed(1);

                requestAnimationFrame(loop);
            }
            loop();
        }
        run();
    </script>
</body>
</html>